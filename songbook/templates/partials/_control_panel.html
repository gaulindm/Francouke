{% load static %}
<div class="content-section">
        {% if user.is_authenticated %}<h3>Modify</h3>(must be logged in<br> 
    <a class="btn btn-secondary btn-sm-mt-1 mb-1" href="{% url 'song-update' score.id %}">Update</a>
    
    
            {% endif%}
    
    
    
    
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <p class='text-muted'>
      <ul class="list-group">
        <li class="list-group-item list-group-item-heavy"><h3>Control Panel</h3>
        </li>
        <label for="transpose-select">Transpose:</label>
        <select id="transpose-select" class="form-control">
            <option value="0">Original Key</option>
            <option value="-7">-7 semitone</option>
            <option value="-6">-6 semitone</option>
            <option value="-5">-5 semitone</option>
            <option value="-4">-4 semitone</option>
            <option value="-3">-3 semitone</option>
            <option value="-2">-2 semitone</option>
            <option value="-1">-1 semitone</option>
            <option value="1">+1 semitone</option>
            <option value="2">+2 semitone</option>
            <option value="3">+3 semitone</option>
            <option value="4">+4 semitone</option>
            <option value="5">+5 semitone</option>
            <option value="6">+6 semitone</option>
            <option value="7">+7 semitone</option>
        </select>
        
        <button id="update-preview" class="btn btn-primary">Update Print Preview</button>
        </li>
        <!-- Lyrics and Chords Appearance -->
        <li class="list-group-item list-group-item-heavy">
            <strong>Lyrics and Chords Appearance</strong>
            <div class="control-panel mt-12 d-flex flex-wrap align-items-center">
                <!-- Font Size -->
                <div class="me-3">
            <!-- Font Size Controls -->
<strong>Font Size:</strong>
<button id="decreaseFontSize" class="btn btn-secondary">−</button>
<span id="fontSizeDisplay">13px</span>
<button id="increaseFontSize" class="btn btn-secondary">+</button>
          </div>
      </li>

      
      
  </ul>
</div>
<div>
{% if score.metadata.youtube %}
    <p>YouTube Link: <a href="{{ score.metadata.youtube }}" target="_blank">Watch on YouTube</a></p>
    <button onclick="playSong('{{ score.metadata.youtube }}')">Play Video</button>
</div>

<div id="youtube-player-container" style="margin-top: 20px;"></div>
{% else %}
    <p>No YouTube video available for this song.</p>
{% endif %}

</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    let fontSizeDisplay = document.getElementById("fontSizeDisplay");
    let decreaseButton = document.getElementById("decreaseFontSize");
    let increaseButton = document.getElementById("increaseFontSize");
    let resetButton = document.getElementById("resetFontSize");

    let defaultFontSize = 13;
    let currentFontSize = parseInt(userFontSize) || defaultFontSize;

    function updateFontSize(newSize) {
    currentFontSize = newSize;
    fontSizeDisplay.textContent = currentFontSize + "px";

    // Apply font size globally
    document.querySelectorAll(".lyrics, .chord").forEach(el => {
        el.style.fontSize = currentFontSize + "px";
    });

    // Save to Django and then refresh PDF preview
    saveFontSize(currentFontSize, refreshPDFPreview);
}


    decreaseButton.addEventListener("click", () => updateFontSize(currentFontSize - 1));
    increaseButton.addEventListener("click", () => updateFontSize(currentFontSize + 1));
    resetButton.addEventListener("click", () => updateFontSize(defaultFontSize));

    function saveFontSize(fontSize, callback) {
    let formData = new FormData();
    let csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    let csrfToken = csrfTokenElement ? csrfTokenElement.value : '';

    formData.append("csrfmiddlewaretoken", csrfToken);
    formData.append("font_size", fontSize);

    fetch("/update_preferences/", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": csrfToken }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            console.log("✅ Font size updated:", fontSize);

            // ✅ Call callback function (refresh PDF preview)
            if (callback) callback();
        } else {
            console.error("❌ Error:", data.message);
        }
    })
    .catch(error => console.error("Fetch error:", error));
}
function refreshPDFPreview() {
    console.log("🔄 Refreshing PDF preview...");

    fetch(`/format_song/{{ score.id }}/`)  // Adjust if needed
    .then(response => response.json())
    .then(data => {
        document.getElementById("song-content").innerHTML = data.html;
        console.log("✅ PDF preview updated!");
    })
    .catch(error => console.error("❌ PDF Refresh Error:", error));
}


    // Apply saved font size on page load
    fontSizeDisplay.textContent = currentFontSize + "px";
    document.querySelectorAll(".lyrics, .chord").forEach(el => {
        el.style.fontSize = currentFontSize + "px";
    });
});

document.addEventListener("DOMContentLoaded", function() {
    let fontSizeDisplay = document.getElementById("fontSizeDisplay");
    let currentFontSize = parseInt(userFontSize);  // Load from Django

    fontSizeDisplay.textContent = currentFontSize + "px";
    document.querySelectorAll(".lyrics, .chord").forEach(el => {
        el.style.fontSize = currentFontSize + "px";
    });
});

</script>
<script>
    let userFontSize = "{{ request.user.userpreference.font_size|default:'13px' }}";
</script>